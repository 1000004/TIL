### ch 4 프로그램의 구조와 실행
#### 프로그램의 구조와 인터럽트
- 우리가 사용하는 컴퓨터 프로그램은 어떤한 프로그램은 어떠한 프로그램 언어로 작성되었든 그 내부 구조는 함수들로 구성
- 프로그램이 CPU에서 명령을 수행하려면 해당 명령을 담은 프로그램의 주소 영역이 메모리에 올라가 있어야 한다.
- 프로그램의 주소 영역 코드(code),데이터(data),스택(stack)
- 코드 영역 - 우리가작성한 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 기계어 명령 형태로 저장되는 부분
- 데이터 영역 - 전역 변수 등 프로그램이 사용하는 데이터를 저장하는 부분
- 스택 영역 - 함수가 호출될 때 호출된 함수의 수행을 마치고 주소 및 데이터를 임시로 저장하는 데에 사용되는 공간
- 돌아와야 하는 지점을 스텍에 지정
- CPU가 명령을 순차적으로 수행하다가 호출된 함수의 위치로 점프해서 새로운 위치의 명령을 실행
- 호출된 함수를 모두 수행하고 나면 원래 함수가 수행되던 위치로 돌아가는덷, 이때 스택에 저장되어 있는 복귀 주소를 사용
- 인터럽트의 동작 원리도 함수의 호출과 비슷
- 일반적 프로그램 내에 발생되는 함수호출에 필요한 복귀 주소는 각 프로그램의 주소 공간 중 스택 영역에 보관
- 반면 인터럽트 때문에 CPU를 빼앗긴 위치를 운영체제가 관리하는 프로세스 제어블록에 저장
#### 컴퓨터 시스템의 작동 개요
- 프로그램 카운터 - CPU가 수행해야 할 메모리 주소를 담고 있는 레지스터
- CPU는 매번 프로그램 카운터가 가르지는 메모리 위치의 명령을 처리
- (CPU에서 명령을 수행되는 부분과, 컴퓨터 욉부장치와 입출력이 이루어지는 부분을 총체적으로 이해하긱 위해서는 컴퓨터의 구성에 대한 폭넓은 이해 필요)
- (컴퓨터 시스템을 구성하는 하드웨어로 먼저 CPU와 메모리가 있고, 이 밖에 각 입출력 장치와 이들 장치를 전담하는 작은 CPU와 메모리를 각각 입출력 컨트롤러와 로컬버ㅓ버퍼라고 부른다)
- 프로그램 카운터가 메모리 주소 중 운영체제가 존재하는 부분을 가르키고 있으면 **커널모드**
- 프로그램 카운터가 사용자 프로그램이 존재하는 메모리 위치를 가르키고 있다면 **사요자모드**
- CPU가 수행하는 명령 일반명령/특권명령
- 일반명령 : 메모리에서 자료를 읽어와 CPU에서 계산하고 결과를 메모리에 쓰는 일련의 명령(모든 프로그램이 수행)
- 특권명령 : 보안이 필요한 명령으로 입출력 장치, 타이머 등 각종 장치에 접근하는 명령(운영체제만 수행할 수 있도록 제한)
- 두 명령의 실행 가능성 체크 모드비트 [ch3](https://github.com/yeRim650/TIL/blob/main/OS/ositp/CH3.md) 참고
#### 프로그램의 실행
- '프로그램 실행되고 있다'는 것은 컴퓨터 시스템 차원에서 두가지 중요한 의미
  - 디스크에 존재하던 실행파일이 메모리에 적재된다는 의미
  - 프로그램이 CPU를 할당받고 명령을 수행하고 있는 상태라는 의미
- 매시점 CPU에서 명령을 수행하는 프로그램은 기껏해야 하나뿐이지만 여러 프로그램이 짧은 시간 단위로 CPU를 나누어 쓰고, 이들 프로그램이 메모리에 적제되어 있을 수 있으므로 여러 프로그램이 동시에 실행된다는 말을 봅편적으로 사용
- 프로그램 주소 공간 중 당장 CPU의 수행이 필요한 부분은 메모리에 올려놓고 그렇지 않은 부분은 디스크 중 메모리의 연장 공간으로 사용되는 스왑 영역에 내려놓는 방식으로 운영
- 프로세스 주소 공간 코드, 데이터, 스택 각각으 프로그램마다 이러한 주소 공간을 별도로 가지며, 프로그램마다 독자적으로 존재하는 이와 같은 주소 공간을 우리는 **가상 메모리 또는 노리적 메모리**
- 실제 물리적 메모리의 주소와 독립적으로 각 프로그램마다 독자적인 주소 공간을 가지기 때문에 지칭하는 용어
- 운영체체도 하나의 프로그램 운영체제 커널 역시 코드, 데이터, 스텍의 주소 공간 구성
- 운영체제의 기능이 그 아랫단의 하드웨어 지원을 효율적으로 관리하는 것과 윗단의 응용프로그램 및 사용자에게 편리한 서비스를 제공
- 커널의 코드 - CPU, 메모리 등의 자원을 관리하기 위한 부분과 사용자에게 편리한 인터페이스를 제공하기 위한 부분
- 커널의 데이터 영역 - 각종 지원을 관리하기 위한 자료구조가 저장 CPU나 메모리와 같은 하드웨어 자원을 관리하가 위한 자료구조뿐 아니라 현재 수행 중인 프로그램을 고간리하기 위한 자료구조도 커널의 데이터 영역에 유지
- 현재 수행 중인 프로그램 - 프로세스
- 커널 데이터 영역 내에는 각 프로세스의 상태, CPU 사용 정보, 메모리 사용 정보 등을 유지하기 위한 자료구조 - PCB
- 커널의 데이터 영역에는 하드웨어와 소프트웨어를 포함하는 시스템내의 모든 자원을 관리하기 위한 자료구조를 각각 유지
- 커널 스택영역 - 함수호출시의 복귀 주소를 주소를 저장하기 위한 용도로 사용
- 일반 사용자 프로그램의 스택과 달리 현재 수행 중인 프로세스마다 별도의 스택을 두어 관리
- 프로그림이 자기 자신의 코드 내에서 함수호출 및 복귀 주소를 유지하기 위해서는 자기 주소 공간 내의 스택을 사용하고, 시스템 콜이나 인터럽트 등에 운영체제의 코드가 실행되는 중에 함수 호출이 발생할 경우 커널 스택
- 커널 스택은 프로세스마다 별도로 두고 있어, 커널 내에 이루어지는 함수 호툴은 직전에 CPU를 가지고 있던 프로세스의 커널스택을 사용
#### 사용자 프로그램이 사용하는 함수
- 프로그램이 사용하는 함수 사용자 정의함수/라이브러리 함수/커널 함수
- 사용자 정의함수 : 프로그래머 본인 직접 작성한 함부
- 라이브러리 함수 : 프로그래머 본인이 직접 작성하지 않았지만 이미 누군가 작성해놓은 함수를 호출만 하여 사용하는 경우
- 사용자 정의함수와 라이브러리 함수는 모두 그 프로그램 코드 영역에 기계어 명령 형태로 존재
- 이 두 함수는 프로그램이 실행될 때에 해당 프로세스의 주소 공간에 포함
- 커널 함수 : 운영체제 커널의 코드에 정의된 함수
- 커널 함수 종류 콜함수, 인터럽트 처리함수
- 커널 함수는 운영체제 커널의 주소 공간에 코드가 정의
- 운영체제 내에 있는 함수를 사용자 프로그램이 호출해서 사용
- printf()내에서 커널함수를 호출하는 시스템 콜을 동반
- 일반적인 함수 호출은 사용자 프로그램 내에 존재하는 코드를 실행하는 것이고 시스템 콜은 사용자 프로그램이 아닌 운영체제라는 별개의 프로그램에 CPU를 넘겨서 실행
- CPU를 운영체제에 넘기기 위해 시스템콜은 인터럽트와 동일한 메커니즘, 즉 CPU의 인터럽트 라인을 세팅
#### 인터럽트
- 원칙적으로는 인터럽트 처리 중에 또 다른 인터럽트가 발생하는 것을 허용하지 않는다
- 데이터의 일관성이 유지되지 않는 문제가 발생
- 예외가 존재 필요성 예를 들어 인터럽트가 발생해 현재 인터럽트가 발생해 현재 인터럽트 처리루틴을 수행하고 있지만, 그보다 더 시급하거나 CPU를 당장 사용해야 하는 일이 발생할 수 있기 때문이다.
- 인터럽트마다 중요도가 다르기 때무에 상대적으로 낮은 중요도를 가진 인터럽트를 처리하는 도중에 중요도가 더 높은 인터럽트가 발생하는 것을 허락할 필요가 있다
#### 시스템 콜
- 모든 프로그램은 자기 자신의 독자적인 주소 공간을 가지고 있으면, 프로그램이 함수호출을 하는 경우 자신의 주소 공간 내에서 호출이 이루어지게 된다
- 시스템 콜은 비록 함수호출이기는 하지만 자신의 주소 공간을 거스르는 영역에 존재하는 함수를 호출
- 자신의 프로그램이 아닌, 커널이라는 다른 프로그램의 주소 공간에 존재하는 함수를 호출하는 것
- 일반적인 함수호출이 자신의 스택에 복귀 주소를 저장한 후 호출된 함수 위치로 점프하는 것임에 비해, 시스템 콜은 주소공간 자체가 다른 곳으로 이동해야 하므로 일반 함수호출과는 상이한 방법을 사용
- 그 방법은 프로그램 자신이 인터럽트 라인에 인터럽트를 세팅하는 명령을 통해 이루어진다
- 프로그램이 스스로 인터럽트 라인을 세팅한다는 점만 다를 뿐 일반적인 인터럽트의 발생과 동일한 방법
- 운영체제는 설정된 인터럽트 라인에 의해 이번에 발생한 인터럽트각 입출력을 요청하는 인터럽트임을 인지
- 해당 서비스루틴으로 이동해 입출력 작업을 수행
- 대부분의 경우 운영체제는 입출력을 요청한 다음 CPU의 제어권을 다른 프로세스에게 이양
- CPU를 할당받고 명렬을 수행하다가 중간에 CPU를 빼앗기는 경우 크게 두 가지
  - 타이머에 의해 인터럽트 발생 
    - 타이머는 특정 프로그램에 의해 CPU가 독점되는 것을 방지하기 위한 하드웨어 CPU 할당시간이 만료되면 인터럽트 발생
    - 여러 프로셋스가 CPU를 나누어 사용하는 시분할 시스템의 구현을 위한 필수적인 요소
  - 입출력을 위해 시스템 콜
 #### 프로세스의 두가지 실행 상태
 - 하나의 프로세스가 시작되어 수행을 완료하기까지는 프로세스 자신의 주소 공간에 있는 코드만 실행되는 것이 아니라 커널의 주소 공간에 있는 코드도 실행
 - 프로그램이 사용자 정의함수나 라이브러리 함수뿐 아니라 입출력 시스템 콜 등을 통해 운영체제 커널의 함수도 호출하여 실행
 - 시스템 콜을 통해 실행되는 것이 프로세스 A의 코드가 아닌 운영체제 커널의 코드이지만, 시스템 콜이 수행되는 동안 커널이 실행 상태에 있다고 하지 않고 프로세스 A가 실행 상태에 있다고 말한다는 점이다.
 - 프로그램의 실행이 끝날 때에는 커널모드로 진입해 프로그램을 종료
